[tox]
envlist = py310, py311, py312, py313, py314, lint, doctest, docs
skip_missing_interpreters = true
# Use uv for faster dependency installation (10-100x faster than pip)
requires = tox-uv
# Place tox workdir outside OneDrive to avoid sync-induced file locks
toxworkdir = {env:TEMP:temp}/tox-kstlib
# Force clean rebuild: tox -r (or --recreate) to delete and recreate all envs

[testenv]
passenv =
    TERM
    COLORTERM
    FORCE_COLOR
    PY_COLORS
setenv =
    PY_COLORS = 1
    FORCE_COLOR = 1
    # Write coverage data to temp dir to avoid OneDrive sync race conditions
    COVERAGE_FILE = {envtmpdir}/.coverage
    # Force copy mode instead of hardlinks (OneDrive incompatibility)
    UV_LINK_MODE = copy
# Supply chain: use PEP 751 lockfile (pylock.toml) with SHA256 hash verification.
# This ensures reproducible builds with the exact dependency versions tested.
skip_install = true
commands_pre =
    uv pip sync {toxinidir}/pylock.toml --python {envpython}
    uv pip install -e {toxinidir} --no-deps --python {envpython}
commands =
    # Exclude CLI and integration tests from main runs (run separately: tox -e cli, tox -e integration)
    pytest tests/ \
        -m "not cli and not integration" \
        --cov=kstlib \
        --cov-config={toxinidir}/.coveragerc-nocli \
        --cov-report=term-missing \
        --cov-report=html \
        --cov-fail-under=95 \
        --strict-markers \
        --tb=short \
        -v

[testenv:lint]
skip_install = true
commands_pre =
    uv pip sync {toxinidir}/pylock.toml --python {envpython}
    uv pip install -e {toxinidir} --no-deps --python {envpython}
commands =
    # Ruff: STRICT checks on src/ only (production code quality)
    # Ignored rules (minimal - only unavoidable style preferences):
    #
    # DOCSTRINGS & FORMATTING:
    #   D203,D213 - Docstring blank line conflicts (mutually exclusive rules)
    #   D205,D212,D400,D413,D415,D401,D403 - Docstring formatting (punctuation, imperative mood)
    #   E501 - Line too long (ASCII art logos, long URLs/licenses in meta.py)
    #
    # TYPE ANNOTATIONS:
    #   ANN204 - Missing return type on __init__ (always None by definition)
    #   ANN401 - typing.Any disallowed (necessary for dynamic **kwargs in logging)
    #
    # CODE STYLE (minimal exceptions):
    #   FBT001,FBT002,FBT003 - Boolean arguments (acceptable Python pattern)
    #   TRY003,EM101,EM102 - Exception message style (f-strings in raise OK)
    #   COM812 - Trailing comma preferences
    #   RET504 - Unnecessary assignment before return (readability)
    #   ERA001 - Commented code (keep TODO documentation)
    #   A004 - Shadowing builtins (intentional: from rich import print)
    #   PIE790,PYI013 - Exception ellipsis (...) in base exception classes
    #   ARG001 - Unused arguments (already handled with pylint disable)
    #   RSE102 - Unnecessary parentheses (typer.Exit() standard pattern)
    #   PLC0415 - Import not at top-level (lazy imports for circular dependency avoidance)
    #   PLW0603 - Global statement (needed for lazy loading traceback flag)
    #   TRY300 - Return in try block (clear structure in __getattr__)
    #
    # TODO TRACKING:
    #   TD002,TD003,FIX002 - TODO format (tracked in GitHub issues/roadmap)
    #
    # SECURITY FALSE POSITIVES:
    #   S101 - Assert used for type narrowing (not removed in -O mode, checked by mypy)
    #   S105 - False positive for enum values like REFRESH_TOKEN
    #
    # ADDITIONAL STYLE:
    #   D107 - Missing __init__ docstring (simple error classes don't need it)
    #   PLR2004 - Magic values (3=JWT parts, 4=base64 padding are self-documenting)
    #   TRY301 - Abstract raise (stylistic, raise in try block is fine)
    #   PERF203 - try-except in loop (necessary for server loops)
    #   BLE001 - Blind exception catching (intentional in auth module for best-effort refresh)
    ruff check src/ --fix --select ALL --ignore D203,D213,D205,D212,D400,D413,D415,D401,D403,E501,ANN204,ANN401,FBT001,FBT002,FBT003,TRY003,TRY300,EM101,EM102,COM812,RET504,ERA001,A004,PIE790,PYI013,ARG001,RSE102,PLC0415,PLW0603,TD002,TD003,FIX002,S101,S105,D107,PLR2004,TRY301,PERF203,BLE001,N802

    # Ruff: Format verification (src/ and tests/ only, examples/ excluded)
    ruff format --check src/ tests/

    # Mypy: STRICT type checking for library and tests
    # Examples excluded (local imports not installed as package)
    mypy src/ tests/ --strict --warn-unreachable --warn-redundant-casts --config-file {toxinidir}/pyproject.toml

[testenv:cli]
description = CLI tests (run manually: tox -e cli)
skip_install = true
commands_pre =
    uv pip sync {toxinidir}/pylock.toml --python {envpython}
    uv pip install -e {toxinidir} --no-deps --python {envpython}
commands =
    # Run only CLI tests (excluded from main tox runs)
    pytest tests/ \
        -m cli \
        --cov=kstlib.cli \
        --cov-report=term-missing \
        --cov-report=html \
        --strict-markers \
        --tb=short \
        -v

[testenv:integration]
description = Integration tests requiring real infrastructure (run manually: tox -e integration)
skip_install = true
commands_pre =
    uv pip sync {toxinidir}/pylock.toml --python {envpython}
    uv pip install -e {toxinidir} --no-deps --python {envpython}
commands =
    # Run only integration tests (WebSocket testnet, OAuth providers, etc.)
    # These tests require real external services and are excluded from main runs
    pytest tests/ \
        -m integration \
        --cov=kstlib \
        --cov-report=term-missing \
        --cov-report=html \
        --strict-markers \
        --tb=short \
        -v

[testenv:doctest]
description = Verify docstring examples are executable and accurate
skip_install = true
commands_pre =
    uv pip sync {toxinidir}/pylock.toml --python {envpython}
    uv pip install -e {toxinidir} --no-deps --python {envpython}
commands =
    # Run doctests on all source modules
    # This ensures documentation examples stay in sync with code behavior
    pytest --doctest-modules src/kstlib/ \
        --ignore=src/kstlib/__main__.py \
        --ignore=src/kstlib/cli/ \
        -v \
        --tb=short

[testenv:docs]
description = Build Sphinx documentation and fail on any warning
skip_install = true
changedir = docs
commands_pre =
    uv pip sync {toxinidir}/pylock.toml --python {envpython}
    uv pip install -e {toxinidir} --no-deps --python {envpython}
commands =
    # Clean previous build artifacts (cross-platform)
    python -c "import shutil; shutil.rmtree('build', ignore_errors=True)"
    # Build HTML docs with warnings as errors (-W)
    # NOTE: Do NOT add -n (nitpicky) - generates hundreds of false positives
    # on type references (None, Path, etc.) with no real documentation value.
    sphinx-build -W -b html source build/html